<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç†µÂ·è§†ç•Œ // å°ç‹å­</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            user-select: none; -webkit-user-select: none;
            -webkit-touch-callout: none;
            cursor: crosshair;
        }
        
        canvas {
            display: block; width: 100%; height: 100%;
            transform: scaleX(-1); /* é»˜è®¤é•œåƒï¼ŒJSä¼šè‡ªåŠ¨è°ƒæ•´ */
            transition: transform 0.5s ease;
        }

        /* æç®€UIå±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        #title-tag {
            position: absolute; top: 20px; left: 20px;
            color: rgba(0, 255, 128, 0.5); font-size: 12px; letter-spacing: 2px;
        }
        
        #hud-text {
            position: absolute; bottom: 20px; right: 20px;
            text-align: right; color: #0f0;
            font-size: 12px; text-shadow: 0 0 5px #0f0;
            line-height: 1.6; font-weight: bold;
        }

        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: rgba(0, 255, 128, 0.3);
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* é•¿æŒ‰åé¦ˆåŠ¨ç”» */
        #touch-feedback {
            position: absolute; width: 80px; height: 80px;
            border: 2px solid #0f0; border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none; z-index: 50; display: none;
        }
        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        /* åˆå§‹æç¤º */
        #start-hint {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 255, 0, 0.6); font-size: 14px;
            pointer-events: none; animation: fadeOut 5s forwards;
            text-align: center; width: 100%; letter-spacing: 1px;
        }
        @keyframes fadeOut { 0%{opacity:1;} 70%{opacity:1;} 100%{opacity:0;} }

        /* è®¾ç½®é¢æ¿ (æ¨¡æ€æ¡†) */
        #settings-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; transition: opacity 0.3s;
        }
        #settings-modal.active { opacity: 1; }

        .modal-box {
            width: 85%; max-width: 340px;
            border: 1px solid #0f0; padding: 25px;
            background: rgba(0, 20, 0, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            text-align: left; color: #0f0;
        }

        h2 { margin-top: 0; text-align: center; border-bottom: 1px dashed #0f0; padding-bottom: 10px; font-size: 18px; letter-spacing: 2px;}

        .control-group { margin-bottom: 20px; }
        .label { font-size: 12px; color: #88a; margin-bottom: 8px; display: block; }
        
        select {
            width: 100%; background: #001100; color: #0f0;
            border: 1px solid #0f0; padding: 10px; 
            font-family: inherit; outline: none;
        }

        /* é‡è¦çš„æç¤ºæ–‡å­— - ä¼˜åŒ–å */
        .warning-box {
            margin-top: 20px;
            border-left: 3px solid #ffaa00;
            background: rgba(50, 30, 0, 0.4);
            color: #ccc;
            padding: 10px;
            font-size: 12px;
            line-height: 1.6;
        }
        .warning-title { color: #ffaa00; font-weight: bold; display: block; margin-bottom: 5px; }

        .btn-close {
            width: 100%; margin-top: 20px; padding: 12px;
            background: #0f0; color: #000; font-weight: bold; border: none;
            cursor: pointer; font-family: inherit;
        }
    </style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="output"></canvas>

<!-- UI å±‚ -->
<div id="ui-layer">
    <div class="scan-line"></div>
    <div id="title-tag">å°ç‹å­ï¼šç†µ Â· è§†ç•Œ</div>
    <div id="start-hint">é•¿æŒ‰å±å¹•å‘¼å‡ºæ§åˆ¶å°<br>Long Press to Configure</div>
    <div id="hud-text">
        SYSTEM: ONLINE<br>
        <span id="fps">FPS: 00</span> | æ‰°åŠ¨: <span id="delta">0.00</span>
    </div>
</div>

<!-- é•¿æŒ‰åé¦ˆ -->
<div id="touch-feedback"></div>

<!-- è®¾ç½®é¢æ¿ -->
<div id="settings-modal">
    <div class="modal-box">
        <h2>å°ç‹å­</h2>
        
        <div class="control-group">
            <span class="label">æ‘„åƒå¤´è¾“å…¥æº / CAMERA SOURCE</span>
            <select id="camera-select" onchange="switchCamera(this.value)">
                <option value="">æ­£åœ¨è·å–...</option>
            </select>
        </div>

        <div class="control-group">
            <span class="label">è§†è§‰å…‰è°± / COLOR SPECTRUM</span>
            <select id="color-mode" onchange="changeColorMode(this.value)">
                <option value="default">é»˜è®¤ï¼šèµ›åšéœ“è™¹ (Cyber)</option>
                <option value="matrix">é»‘å®¢å¸å›½ (Matrix Green)</option>
                <option value="inferno">ç‚¼ç‹±çƒ­æµª (Red Inferno)</option>
                <option value="spectre">å¹½çµç²’å­ (White Spectre)</option>
            </select>
        </div>

        <!-- ä¼˜åŒ–åçš„è¯´æ˜æ–‡æ¡ˆ -->
        <div class="warning-box">
            <span class="warning-title">âš ï¸å°ç‹å­æŒ‡å—æç¤º</span>
            1. å»ºè®®ä¿æŒè®¾å¤‡<b>ç»å¯¹é™æ­¢</b>ï¼Œåˆ‡å‹¿æ™ƒåŠ¨ã€‚<br>
            2. æœ¬ç³»ç»ŸåŸºäº<b>æ—¶åºå·®åˆ†ç®—æ³•</b>ï¼Œä»…ä¾¦æµ‹ç”»é¢ä¸­çš„ç›¸å¯¹ä½ç§»ã€‚<br>
            3. è‹¥ç§»åŠ¨è®¾å¤‡ï¼Œä¼šå¯¼è‡´å…¨å±æ•°æ®è¿‡è½½ï¼ˆèŠ±å±ï¼‰ã€‚
            4. è‹¥ç§»åŠ¨è®¾å¤‡ï¼Œå›ºå®šå¥½ä½ç½®ï¼Œå‰ç½®æ‘„åƒå¤´æ”¾è¿œä¸€äº›ã€‚
        </div>

        <button class="btn-close" onclick="closeSettings()">è¿”å›è§‚æµ‹ (RESUME)</button>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const modal = document.getElementById('settings-modal');
    const feedback = document.getElementById('touch-feedback');
    const fpsSpan = document.getElementById('fps');
    const deltaSpan = document.getElementById('delta');

    let w, h;
    let stream = null;
    let particles = [];
    const chars = " .:-=+*#%@"; 
    let prevFrame = null;
    let colorMode = 'default';

    // --- 1. é•¿æŒ‰äº¤äº’ ---
    let pressTimer;
    let isPressing = false;

    const startPress = (x, y, target) => {
        if (target.closest('.modal-box')) return;
        isPressing = true;
        showFeedback(x, y);
        pressTimer = setTimeout(() => {
            if (isPressing) {
                openSettings();
                hideFeedback();
                isPressing = false;
            }
        }, 800);
    };

    const endPress = () => {
        isPressing = false;
        clearTimeout(pressTimer);
        hideFeedback();
    };

    document.addEventListener('touchstart', e => startPress(e.touches[0].clientX, e.touches[0].clientY, e.target));
    document.addEventListener('touchend', endPress);
    document.addEventListener('touchmove', endPress);
    document.addEventListener('mousedown', e => startPress(e.clientX, e.clientY, e.target));
    document.addEventListener('mouseup', endPress);
    document.addEventListener('mouseleave', endPress);

    function showFeedback(x, y) {
        feedback.style.left = x + 'px';
        feedback.style.top = y + 'px';
        feedback.style.display = 'block';
        feedback.style.animation = 'ripple 1s infinite';
    }

    function hideFeedback() {
        feedback.style.display = 'none';
        feedback.style.animation = 'none';
    }

    function openSettings() {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
        enumerateCameras();
    }

    function closeSettings() {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function changeColorMode(mode) { colorMode = mode; }

    // --- 2. æ‘„åƒå¤´é€»è¾‘ ---
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        try {
            await startStream();
            enumerateCameras();
        } catch (err) {
            console.error(err);
            alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥å¯åŠ¨");
        }
        requestAnimationFrame(loop);
    }

    async function startStream(deviceId = null) {
        if (stream) stream.getTracks().forEach(t => t.stop());
        
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    facingMode: deviceId ? undefined : 'user',
                    width: { ideal: 1280 }, // è¯·æ±‚è¾ƒé«˜åˆ†è¾¨ç‡
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            await video.play();

            const track = stream.getVideoTracks()[0];
            const label = track.label.toLowerCase();
            const isBack = label.includes('back') || label.includes('rear') || label.includes('environment');
            canvas.style.transform = isBack ? 'scaleX(1)' : 'scaleX(-1)';

        } catch (err) { console.error(err); }
    }

    function switchCamera(id) { if(id) startStream(id); }

    async function enumerateCameras() {
        const select = document.getElementById('camera-select');
        const currentVal = select.value;
        select.innerHTML = '';
        const devices = await navigator.mediaDevices.enumerateDevices();
        devices.filter(d => d.kind === 'videoinput').forEach((d, i) => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            let label = d.label || `Camera ${i+1}`;
            if (label.toLowerCase().includes('back')) label = `ğŸ“¸ åç½® ${i+1}`;
            else if (label.toLowerCase().includes('front')) label = `ğŸ‘¤ å‰ç½® ${i+1}`;
            opt.text = label;
            select.appendChild(opt);
        });
        if (currentVal) select.value = currentVal;
    }

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }

    // --- 3. ç²’å­ç³»ç»Ÿ ---
    class GlitchParticle {
        constructor(x, y, intensity) {
            this.x = x; this.y = y; this.life = 1.0;
            this.speedX = (Math.random()-0.5)*2;
            this.speedY = (Math.random()-0.5)*2;
            this.intensity = intensity;
        }
        update() { this.x+=this.speedX; this.y+=this.speedY; this.life-=0.05; }
        
        draw(ctx) {
            let color;
            if (colorMode === 'default') {
                color = this.intensity > 50 ? `255, ${Math.floor(255-this.intensity*2)}, 100` : `0, ${Math.floor(this.intensity*5+100)}, 255`;
            } else if (colorMode === 'matrix') {
                color = `0, 255, 0`;
            } else if (colorMode === 'inferno') {
                color = `255, ${Math.floor(200-this.intensity*2)}, 0`;
            } else if (colorMode === 'spectre') {
                color = `200, 200, 255`;
            }
            ctx.fillStyle = `rgba(${color}, ${this.life})`;
            ctx.fillRect(this.x, this.y, 4*this.life, 4*this.life);
        }
    }

    let lastTime = 0;

    // --- 4. ä¸»å¾ªç¯ (ä¿®å¤ç”»é¢æ¯”ä¾‹çš„æ ¸å¿ƒ) ---
    function loop(timestamp) {
        if (timestamp - lastTime >= 1000) {
            fpsSpan.innerText = "FPS: " + Math.round(1000 / (timestamp - lastTime) * 60);
            lastTime = timestamp;
        }

        const scale = 12; 
        const cols = Math.floor(w / scale);
        const rows = Math.floor(h / scale);

        if (video.readyState !== 4) { requestAnimationFrame(loop); return; }

        const tCanvas = document.createElement('canvas');
        tCanvas.width = cols; tCanvas.height = rows;
        const tCtx = tCanvas.getContext('2d');

        // === ç”»é¢æ¯”ä¾‹ä¿®å¤æ ¸å¿ƒç®—æ³• (Cover Mode) ===
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const screenAspect = w / h;
        const videoAspect = vw / vh;
        let sx, sy, sw, sh;

        // è®¡ç®—è£å‰ªåŒºåŸŸï¼Œç¡®ä¿å¡«å……å±å¹•ä¸”ä¸å˜å½¢
        if (videoAspect > screenAspect) {
            // è§†é¢‘æ¯”å±å¹•å®½ï¼šè£å‰ªå·¦å³
            sh = vh;
            sw = vh * screenAspect;
            sx = (vw - sw) / 2;
            sy = 0;
        } else {
            // å±å¹•æ¯”è§†é¢‘å®½ï¼ˆé€šå¸¸æ˜¯ç”µè„‘ï¼‰ï¼šè£å‰ªä¸Šä¸‹
            sw = vw;
            sh = vw / screenAspect;
            sx = 0;
            sy = (vh - sh) / 2;
        }

        // åªç»˜åˆ¶è£åˆ‡åçš„éƒ¨åˆ†åˆ°ä¸´æ—¶ç”»å¸ƒ
        tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, cols, rows);
        const frameData = tCtx.getImageData(0, 0, cols, rows).data;

        // èƒŒæ™¯
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        ctx.fillRect(0, 0, w, h);

        let totalMotion = 0;

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const i = (y * cols + x) * 4;
                const r = frameData[i];
                const g = frameData[i + 1];
                const b = frameData[i + 2];
                const brightness = (r + g + b) / 3;

                let diff = 0;
                if (prevFrame) {
                    diff = Math.abs(r - prevFrame[i]) + Math.abs(g - prevFrame[i+1]) + Math.abs(b - prevFrame[i+2]);
                }

                const screenX = x * scale;
                const screenY = y * scale;

                if (diff > 30) { 
                    totalMotion += diff;
                    const charIndex = Math.floor((brightness / 255) * (chars.length - 1));
                    const char = chars[charIndex];
                    ctx.font = `bold ${scale}px monospace`;

                    if (colorMode === 'default') {
                        const rCol = Math.min(255, diff * 2);
                        const gCol = Math.max(0, 255 - diff);
                        const bCol = 255;
                        ctx.fillStyle = `rgb(${rCol}, ${gCol}, ${bCol})`;
                    } else if (colorMode === 'matrix') {
                        ctx.fillStyle = `rgba(0, 255, 0, ${Math.min(1, diff/50 + 0.5)})`;
                    } else if (colorMode === 'inferno') {
                        ctx.fillStyle = `rgb(255, ${Math.max(0, 200 - diff*2)}, 0)`;
                    } else if (colorMode === 'spectre') {
                        ctx.fillStyle = `rgba(220, 230, 255, ${Math.min(1, diff/40 + 0.4)})`;
                    }
                    
                    ctx.fillText(char, screenX, screenY);

                    if (Math.random() < 0.1) {
                        particles.push(new GlitchParticle(screenX, screenY, diff / 3));
                    }

                } else {
                    if (brightness > 50 && Math.random() > 0.8) { 
                        ctx.fillStyle = 'rgba(0, 50, 0, 0.3)';
                        ctx.font = `${scale}px monospace`;
                        ctx.fillText(Math.random() > 0.5 ? '0' : '1', screenX, screenY);
                    }
                }
            }
        }

        prevFrame = frameData;
        deltaSpan.innerText = (totalMotion / 10000).toFixed(2);

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw(ctx);
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        requestAnimationFrame(loop);
    }
    
    document.body.addEventListener('click', () => {
        if (!video.srcObject) init();
    });
    
    init();

</script>
</body>
</html>
