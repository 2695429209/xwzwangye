<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç‹å­ï¼šç†µ Â· è§†ç•Œ</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            -webkit-touch-callout: none; /* ç¦æ­¢iOSé•¿æŒ‰èœå• */
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
        }
        
        /* ç”»å¸ƒé»˜è®¤æ˜¯é•œåƒçš„ï¼Œåé¢JSä¼šæ ¹æ®æ‘„åƒå¤´è°ƒæ•´ */
        canvas {
            display: block;
            width: 100%; height: 100%;
            transform: scaleX(-1);
            transition: transform 0.5s ease;
        }

        /* æç®€ HUDï¼šå¹³æ—¶åªæ˜¾ç¤ºè¿™ä¸ª */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        
        #hud-text {
            position: absolute; bottom: 20px; right: 20px;
            text-align: right; color: #0f0;
            font-size: 12px; text-shadow: 0 0 5px #0f0;
            line-height: 1.6; font-weight: bold;
        }

        #title-tag {
            position: absolute; top: 20px; left: 20px;
            color: rgba(0, 255, 128, 0.5); font-size: 12px; letter-spacing: 2px;
        }

        /* éšè—çš„è®¾ç½®é¢æ¿ (æ¨¡æ€æ¡†) */
        #settings-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; transition: opacity 0.3s;
        }
        #settings-modal.active { opacity: 1; }

        .modal-box {
            width: 80%; max-width: 300px;
            border: 2px solid #0f0; padding: 20px;
            text-align: center; box-shadow: 0 0 20px rgba(0,255,0,0.2);
        }

        h2 { color: #0f0; margin-top: 0; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }
        
        select {
            width: 100%; background: #002200; color: #0f0;
            border: 1px solid #0f0; padding: 10px; margin: 20px 0;
            font-family: inherit; font-size: 14px; outline: none;
        }

        .btn-close {
            background: #0f0; color: #000; border: none;
            padding: 10px 20px; font-weight: bold; cursor: pointer;
            width: 100%; font-family: inherit;
        }

        /* é•¿æŒ‰æç¤ºåŠ¨ç”» */
        #touch-feedback {
            position: absolute; width: 60px; height: 60px;
            border: 2px solid #0f0; border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none; z-index: 50; display: none;
        }
        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="output"></canvas>

<!-- æç®€ HUD -->
<div id="ui-layer">
    <div id="title-tag">å°ç‹å­ï¼šç†µ Â· è§†ç•Œ</div>
    <div id="hud-text">
        SYSTEM: ONLINE<br>
        <span id="fps">FPS: 00</span> | DELTA: <span id="delta">0.00</span>
    </div>
</div>

<!-- é•¿æŒ‰åé¦ˆåœˆ -->
<div id="touch-feedback"></div>

<!-- è®¾ç½®é¢æ¿ (é•¿æŒ‰å‘¼å‡º) -->
<div id="settings-modal">
    <div class="modal-box">
        <h2>ç¥ç»é“¾è·¯è®¾ç½®</h2>
        <div style="color:#aaa; font-size:12px; margin-bottom:10px;">é€‰æ‹©è§†è§‰è¾“å…¥æº</div>
        
        <select id="camera-select" onchange="switchCamera(this.value)">
            <option value="">æ­£åœ¨è·å–æ‘„åƒå¤´...</option>
        </select>

        <button class="btn-close" onclick="closeSettings()">å…³é—­é¢æ¿</button>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const modal = document.getElementById('settings-modal');
    
    let w, h;
    let stream = null;
    let particles = [];
    const chars = " .:-=+*#%@";
    let prevFrame = null;
    let lastTime = 0;

    // --- 1. æ ¸å¿ƒï¼šé•¿æŒ‰äº¤äº’é€»è¾‘ ---
    let pressTimer;
    const touchFeedback = document.getElementById('touch-feedback');

    document.body.addEventListener('touchstart', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†é‡Œçš„ä¸œè¥¿ï¼Œä¸è§¦å‘é•¿æŒ‰
        if (e.target.closest('.modal-box')) return;

        const touch = e.touches[0];
        showFeedback(touch.clientX, touch.clientY);

        pressTimer = setTimeout(() => {
            openSettings();
            hideFeedback();
        }, 800); // é•¿æŒ‰ 800ms è§¦å‘
    });

    document.body.addEventListener('touchend', cancelPress);
    document.body.addEventListener('touchmove', cancelPress);

    function cancelPress() {
        clearTimeout(pressTimer);
        hideFeedback();
    }

    function showFeedback(x, y) {
        touchFeedback.style.left = x + 'px';
        touchFeedback.style.top = y + 'px';
        touchFeedback.style.display = 'block';
        touchFeedback.style.animation = 'ripple 1s infinite';
    }

    function hideFeedback() {
        touchFeedback.style.display = 'none';
        touchFeedback.style.animation = 'none';
    }

    function openSettings() {
        modal.style.display = 'flex';
        // ç¨å¾®å»¶è¿ŸåŠ  active class ä»¥è§¦å‘é€æ˜åº¦åŠ¨ç”»
        setTimeout(() => modal.classList.add('active'), 10);
        // æ‰“å¼€é¢æ¿æ—¶é‡æ–°æšä¸¾æ‘„åƒå¤´ï¼Œä»¥é˜²æœ‰å˜åŒ–
        enumerateCameras(); 
    }

    function closeSettings() {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // --- 2. æ‘„åƒå¤´é€»è¾‘ (ç«–å± + åˆ‡æ¢) ---
    
    // åˆå§‹åŒ–
    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        try {
            // ç¬¬ä¸€æ¬¡å¯åŠ¨è¯·æ±‚
            await startStream(); 
            // å¯åŠ¨åæšä¸¾è®¾å¤‡å¡«å…¥ä¸‹æ‹‰æ¡†
            enumerateCameras();
        } catch (err) {
            console.error("Camera Init Error:", err);
            alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™");
        }
        requestAnimationFrame(loop);
    }

    // æ™ºèƒ½å¯åŠ¨æµ
    async function startStream(deviceId = null) {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        // æ£€æµ‹æ˜¯å¦ç«–å±
        const isPortrait = window.innerHeight > window.innerWidth;

        const constraints = {
            audio: false,
            video: {
                deviceId: deviceId ? { exact: deviceId } : undefined,
                // å¦‚æœæ²¡æœ‰æŒ‡å®šIDï¼Œé»˜è®¤æ‰¾åç½® (environment)ï¼Œå¦‚æœæƒ³é»˜è®¤å‰ç½®æ”¹ 'user'
                facingMode: deviceId ? undefined : 'environment', 
                // å…³é”®ï¼šç«–å±æ—¶ï¼Œè¯·æ±‚é«˜å¤§äºå®½
                width: { ideal: isPortrait ? 720 : 1280 },
                height: { ideal: isPortrait ? 1280 : 720 }
            }
        };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            await video.play();

            // æ™ºèƒ½é•œåƒåˆ¤æ–­
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            // å¦‚æœæ˜¯å‰ç½®(user)ï¼Œå¼€å¯é•œåƒï¼›å¦‚æœæ˜¯åç½®(environment)ï¼Œå…³é—­é•œåƒ
            // æ³¨æ„ï¼šéƒ¨åˆ†å®‰å“æœºå¯èƒ½ä¸è¿”å› facingModeï¼Œè¿™é‡Œåšä¸ªå…¼å®¹åˆ¤æ–­
            const label = track.label.toLowerCase();
            const isBack = label.includes('back') || label.includes('rear') || label.includes('environment');
            
            if (isBack) {
                canvas.style.transform = 'scaleX(1)'; // åç½®ä¸é•œåƒ
            } else {
                canvas.style.transform = 'scaleX(-1)'; // å‰ç½®é•œåƒ
            }

        } catch (err) {
            console.error("Stream Start Error:", err);
        }
    }

    // åˆ‡æ¢æ‘„åƒå¤´
    function switchCamera(deviceId) {
        if (!deviceId) return;
        startStream(deviceId);
    }

    // æšä¸¾è®¾å¤‡åˆ—è¡¨
    async function enumerateCameras() {
        const select = document.getElementById('camera-select');
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
        const currentVal = select.value;
        select.innerHTML = '';

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');

        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            
            // ä¸­æ–‡ç¿»è¯‘
            let label = device.label || `æ‘„åƒå¤´ ${index + 1}`;
            if (label.toLowerCase().includes('back')) label = `ğŸ“· åç½®é•œå¤´ ${index+1}`;
            else if (label.toLowerCase().includes('front')) label = `ğŸ‘¤ å‰ç½®é•œå¤´ ${index+1}`;
            
            option.text = label;
            select.appendChild(option);
        });

        // å°è¯•æ¢å¤é€‰ä¸­çŠ¶æ€
        if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
            select.value = currentVal;
        } else if (stream) {
            // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•é€‰ä¸­å½“å‰æ­£åœ¨è¿è¡Œçš„
            const currentId = stream.getVideoTracks()[0].getSettings().deviceId;
            select.value = currentId;
        }
    }

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }

    // --- 3. è§†è§‰æ¸²æŸ“é€»è¾‘ (ä¿æŒåŸç‰ˆ) ---
    class GlitchParticle {
        constructor(x, y, intensity) {
            this.x = x; this.y = y;
            this.life = 1.0;
            this.intensity = intensity;
            this.speedY = (Math.random() - 0.5) * 2;
            this.speedX = (Math.random() - 0.5) * 2;
            if (intensity > 50) this.color = `255, ${Math.floor(255 - intensity * 2)}, 100`;
            else this.color = `0, ${Math.floor(intensity * 5 + 100)}, 255`;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.life -= 0.05;
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(${this.color}, ${this.life})`;
            ctx.fillRect(this.x, this.y, 4 * this.life, 4 * this.life);
        }
    }

    function loop(timestamp) {
        if (timestamp - lastTime >= 1000) {
            document.getElementById('fps').innerText = "FPS: " + Math.round(1000 / (timestamp - lastTime) * 60);
            lastTime = timestamp;
        }

        const scale = 12;
        const cols = Math.floor(w / scale);
        const rows = Math.floor(h / scale);

        // è§†é¢‘æµå°±ç»ªæ£€æŸ¥
        if (video.readyState !== 4) {
            requestAnimationFrame(loop);
            return;
        }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = cols;
        tempCanvas.height = rows;
        const tempCtx = tempCanvas.getContext('2d');
        
        // ç®€å•çš„æ‹‰ä¼¸ç»˜åˆ¶ (é€‚åº”ç«–å±)
        tempCtx.drawImage(video, 0, 0, cols, rows);
        const frameData = tempCtx.getImageData(0, 0, cols, rows).data;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
        ctx.fillRect(0, 0, w, h);

        let totalMotion = 0;

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const i = (y * cols + x) * 4;
                const r = frameData[i];
                const g = frameData[i + 1];
                const b = frameData[i + 2];
                const brightness = (r + g + b) / 3;

                let diff = 0;
                if (prevFrame) {
                    diff = Math.abs(r - prevFrame[i]) + Math.abs(g - prevFrame[i+1]) + Math.abs(b - prevFrame[i+2]);
                }

                const screenX = x * scale;
                const screenY = y * scale;

                if (diff > 30) { 
                    totalMotion += diff;
                    const charIndex = Math.floor((brightness / 255) * (chars.length - 1));
                    const char = chars[charIndex];
                    ctx.font = `${scale}px monospace`;
                    
                    const rCol = Math.min(255, diff * 2);
                    const gCol = Math.max(0, 255 - diff);
                    const bCol = 255;
                    ctx.fillStyle = `rgb(${rCol}, ${gCol}, ${bCol})`;
                    ctx.fillText(char, screenX, screenY);

                    if (Math.random() < 0.1) particles.push(new GlitchParticle(screenX, screenY, diff / 3));
                } else {
                    if (brightness > 50 && Math.random() > 0.8) {
                        ctx.fillStyle = 'rgba(0, 50, 0, 0.3)';
                        ctx.font = `${scale}px monospace`;
                        ctx.fillText(Math.random() > 0.5 ? '0' : '1', screenX, screenY);
                    }
                }
            }
        }

        prevFrame = frameData;
        document.getElementById('delta').innerText = (totalMotion / 10000).toFixed(2);

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw(ctx);
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        requestAnimationFrame(loop);
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>